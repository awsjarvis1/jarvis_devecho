gitBranch = params["GIT_BRANCH"]

runBuild()
 
def runBuild() {
    println "===== In runBuild method ===="
    parallelBuilds()
}

def parallelBuilds() {
    //construct parallel jobs list
 
    //build Image
    println "";
    // timestamp
    print new Date();
    println "  Starting Preparation of build Nodes..."
    count = '0';
    stage('Stage 1: Node Prepare for Build and deploy node') {
        if (gitBranch != 'integration'){
            println "  Starting single node preparation for building "+gitBranch
            count = '1';
        } else if(  gitBranch == 'dev/chatui') {
            count = '2';
        }
        else {
            println "  Starting 3 node preparaton for building "+gitBranch
            count = '4';
        }
        build job: 'EC2_instance_n_node_creater',
            parameters: [string(name: 'EC2REGION', value: 'ohio'),
                string(name: 'COUNT', value: count),
                [$class: 'GeneratorKeyValueParameterValue', name: 'NODELABEL', value: 'BUILD']]
        if (gitBranch == 'integration'){
            build job: 'EC2_instance_n_node_creater',
                parameters: [string(name: 'EC2REGION', value: 'ohio'),
                    string(name: 'COUNT', value: '3'),
                    [$class: 'GeneratorKeyValueParameterValue', name: 'NODELABEL', value: 'DEPLOY']]
        }
    }
    build_job = []
    if(gitBranch != 'integration'){
        branchName = gitBranch
        if(branchName == 'dev/chatui'){
            build_job.push('Build_Maven_Job_webapi')
            build_job.push('Build_Maven_Job_webapp')
        } else if(branchName == 'dev/image_processing') {
            build_job.push('Build_Maven_Job_image')
        } else if(branchName == 'dev/loganalytics') {
            build_job.push('Build_Maven_Job_log')
        }
    } else {
        build_job.push('Build_Maven_Job_webapi')
        build_job.push('Build_Maven_Job_webapp')
        build_job.push('Build_Maven_Job_image')
        build_job.push('Build_Maven_Job_log')
    }
    stage('Stage2: Build code changes') {
        def branches = [:]
        for (job_name in build_job) {
            branches[job_name] = transformIntoStep(job_name, gitBranch)
        }
        parallel branches
    }
    stage('Stage3: destroy generated build node') {
        build job: 'EC2_instance_n_node_terminator', parameters: [string(name: 'EC2REGION', value: 'ohio'), [$class: 'GeneratorKeyValueParameterValue', name: 'NODELABEL', value: 'BUILD']]
    }
    if(gitBranch == 'integration'){
        stage('stage4: Start Deploy VM'){
            build 'Deploy_connector_job'
        }
        stage('Stage5: destroy generated deploy node') {
            build job: 'EC2_instance_n_node_terminator', parameters: [string(name: 'EC2REGION', value: 'ohio'), [$class: 'GeneratorKeyValueParameterValue', name: 'NODELABEL', value: 'DEPLOY']]
        }
    }
}

def transformIntoStep(jobFullName, gitBranch) {
    return {
       build job: jobFullName, parameters: [string(name: 'GIT_BRANCH', value: gitBranch)]
    }
}